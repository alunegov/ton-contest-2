"TonUtil.fif" include
"Asm.fif" include

"code.fif" include <s constant code

<b false 1 i, // round
  false 1 i, // old_round
  0 32 u, // seqno
  "lottery.pk" load-generate-keypair constant lottery_pk B, // owner pubkey
b> constant storage

"lottery.addr" load-address-verbose 2constant lottery_addr

// addr_std
<b b{100} s, lottery_addr addr, b> <s =: contract_address_full

0 tuple 0x076ef1ea , // magic
0 , 0 , // actions msg_sents
now , // unix_time
1 , 1 , 0 , // block_lt, trans_lt, rand_seed
0 tuple 9223372036854775807 , dictnew , , // remaining balance
contract_address_full , dictnew , // contract_address, global_config
1 tuple // wrap to another tuple
constant c7

// storage exp_prize_find - 
{
."expecting prize_fund " dup . cr
79045 code 3 roll c7 runvmctx
// ."Updated storage: " cr <s csr. cr
drop
."Exit code " dup . cr
abort"FAIL exit_code"
."r1: " dup . cr
= not abort"FAIL r1"
} : check_prize_fund

storage 0 check_prize_fund

."inc prize_fund" cr
98 <b b{0000} s, b{100} s, lottery_addr addr, b> <b 2 32 u, b> <s
recv_internal code storage c7 runvmctx
constant storage
constant exit_code
."Exit code " exit_code . cr
."Updated storage: " cr storage <s csr. cr
exit_code abort"FAIL exit_code"

storage 98 check_prize_fund

."buy ticket p1" cr
// Grams as int, CommonMsgInfo$0 as cell, 
1 <b b{0000} s, b{100} s, 0 8 u, 1 256 u, b> <b 1 32 u, 0 32 u, 11 8 u, 12 8 u, 79 8 u, b> <s
recv_internal code storage c7 runvmctx
constant storage
constant exit_code
."Exit code " exit_code . cr
."Updated storage: " cr storage <s csr. cr
exit_code abort"FAIL exit_code"

."buy ticket p2" cr
// Grams as int, CommonMsgInfo$0 as cell, 
1 <b b{0000} s, b{100} s, 0 8 u, 2 256 u, b> <b 1 32 u, 0 32 u, 7 8 u, 1 8 u, 2 8 u, b> <s
recv_internal code storage c7 runvmctx
constant storage
constant exit_code
."Exit code " exit_code . cr
."Updated storage: " cr storage <s csr. cr
exit_code abort"FAIL exit_code"

storage 100 check_prize_fund

."lucky_nums2" cr
77502 code storage c7 runvmctx
.s cr
// ."Updated storage: " cr <s csr. cr
drop
."Exit code " dup . cr
abort"FAIL exit_code"
."r1: " <s csr. cr

."winners" cr
128887 code storage c7 runvmctx
.s cr
// ."Updated storage: " cr <s csr. cr
drop
."Exit code " dup . cr
abort"FAIL exit_code"
{ drop } 3 times
{ ."r: " . cr } 3 times

."conduct round" cr
// msg_seqno, valid_until, op
<b 0 32 u, -1 32 i, 2 32 u, b>
dup hashu lottery_pk ed25519_sign_uint
<b swap B, swap <s s, b> <s
recv_external code storage c7 runvmctx
constant storage
constant exit_code
."Exit code " exit_code . cr
."Updated storage: " cr storage <s csr. cr
exit_code abort"FAIL exit_code"

// storage 37 check_prize_fund

."lucky_nums2" cr
77502 code storage c7 runvmctx
.s cr
// ."Updated storage: " cr <s csr. cr
drop
."Exit code " dup . cr
abort"FAIL exit_code"
."r1: " <s csr. cr

."winners" cr
128887 code storage c7 runvmctx
.s cr
// ."Updated storage: " cr <s csr. cr
drop
."Exit code " dup . cr
abort"FAIL exit_code"
{ drop } 3 times
{ ."r: " . cr } 3 times

."is_winner 1" cr
1
118635 code storage c7 runvmctx
.s cr
// ."Updated storage: " cr <s csr. cr
drop
."Exit code " dup . cr
abort"FAIL exit_code"
."r1: " . cr

."is_winner 2" cr
2
118635 code storage c7 runvmctx
.s cr
// ."Updated storage: " cr <s csr. cr
drop
."Exit code " dup . cr
abort"FAIL exit_code"
."r1: " . cr

lottery_addr .addr cr
// lottery_addr 6 .Addr cr
