# TON Contest, Stage 2

## Task

The task was to build one or two TON-based smart-contracts (decentralized services) that can become popular with consumers.

The bonus task in Stage 2 was to fix all bugs and issues discovered by the judges and other contestants in Stage 2. To get a bonus prize, the smart contract or project also requires a top quality web page and video presentation.

## Project structure

- **algo_test** - prize distribution algorithm test
- **back** - web and bot backend
- **bot** - Telegram bot
- **front** - web frontend
- **smc** - smc code and helper scripts

## Lottery "3 of 13" smart-contract

Lottery rules:
- participants choose 3 arbitrary unique numbers 0-99 and "buys" a ticket
- prize fund of current round is a sum of all "sold" tickets in this round, plus "unused" fund from previos round, minus round commision
- sponsors can increase current round prize fund by any amount of GR$
- owner of lottery smc conducts a lottery round (say once per day):
  - generate 13 unique random numbers 0-99
  - find winners and their prize among participants:
    - guess all 3 numbers - 60% of prize fund / winners
    - guess 2 numbers - 22% of prize fund / winners
    - guess 1 number - 15% of prize fund / winners
  - charge smc commision - 3% of prize fund
  - "zeros" current round, "fills" previous round
- results of previous round can be fetched with **lucky_nums**, **prizes** and **is_winner** get-methods
- winners of previous rounds can withdraw their prizes
- owner of lottery smc can withdraw commision only, not the entire smc balance

Current limitations:
- participants can buy only 1 ticker per round

As an owner of lottery smc you can:
- create smart-contract with **lottery-new.fif**
- conduct a lottery round with **lottery-conduct.fif**
- withdraw commison with **lottery-withdraw.fif**

As an participant of lottery you can:
- buy a ticket with 3 numbers 0-99 for GR$1 by sending transfer from your wallet account with message payload generated by **lotto-buy.fif**, or by sending your numbers in comment of transfer from official Gram Wallet app
- sponsor current lottery round with some GR$ by sendidng transfer from your wallet account with message payload generated by **lotto-sponsor.fif**
- withdraw your prize by sending "get"-transfer from your wallet account with message payload generated by **lotto-withdraw.fif**, or by sending transfer with empty comment from official Gram Wallet app

Smc get-methods:
- **seqno**
- **prize_fund** - return prize fund of current round
- **lucky_nums** - return winning nums of previous round
- **prizes** - return prizes (1, 2 and 3 nums matched) of previous round
- **is_winner(wc, addr)** and **is_winner_s(slice addr)** - return prize in all previous rounds for addr

## dev

```sh
cd smc
func -PSR -ocode.fif $FUNCPATH/stdlib.fc code.fc  // compile smc
fift -s <script>.fif                              // run scripts
fift -s lottery-test.fif                          // run tests
```

## Result

**III Place**

Issues from judges:

```
We found some issues in your contract.
Critical:
- The contract ignores existence of processing and storage fees, sending back all funds above 1 gram. It is not evident whether 3% of commission will be enough to cover all the expences. More over, the errors will accumulate and eventually it will be impossible to withdraw all `comsa`, or the `prize_fund` became bigger than contract balance after withdrawing of `comsa`.
Minor:
- "transfer. debug only" operation is not commented out from the code, so owner can steal all the funds.
- There is no check whether chosen numbers belongs to the range 0-99.
- Short time for prize withdrawal and accepting only basechain account can be critical for some use cases.
```

```
The bonus task is not completed, most likely due to a misunderstanding.

WEB SCORE: 0
VIDEO SCORE: 0
=====
Base Reward: EUR 0
OLD BUGS FIXED: 5/5
======
Total: EUR 0
```

# Post contest era

Lottery web page are availiable [here](http://alunegov.gitlab.io/ton-contest-2/).
